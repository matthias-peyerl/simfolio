CREATE TABLE portfolios (id INT, name VARCHAR(80));

CREATE TABLE transactions (
  id INT,
  portfolio_id INT,
  stock_id INT,
  price FLOAT,
  share INT,
  transaction_type VARCHAR(8),
  transaction_date TIMESTAMP
);

CREATE TABLE stock_values (
  id INT,
  stock_id INT,
  value_date TIMESTAMP,
  open_value FLOAT,
  close_value FLOAT,
  high_value FLOAT,
  low_value FLOAT
);

INSERT INTO portfolios (id, name) VALUES ('1', 'my portfolio');
  

INSERT INTO transactions
VALUES
  ('1', '1', '1', '12.34', '3000', 'BUY_SELL', '2019-06-03 15:36:29'),
  ('2', '1', '2', '30.11', '2000', 'BUY_SELL', '2019-06-03 15:36:29'),
  ('3', '1', '1', '15.11', '-1000', 'BUY_SELL', '2019-06-13 15:36:29');
  
  
INSERT INTO stock_values
VALUES
	('1', '1', '2019-06-01 15:36:29', '12.45', '12.45', '12.45', '12.45'),
    ('2', '1', '2019-06-02 15:36:29', '12.45', '12.45', '12.45', '12.45'),
    ('3', '1', '2019-06-03 15:36:29', '12.45', '12.45', '12.45', '12.45'),
    ('4', '1', '2019-06-04 15:36:29', '12.45', '12.45', '12.45', '12.45'),
    ('5', '1', '2019-06-05 15:36:29', '12.45', '12.45', '12.45', '12.45'),
    ('6', '1', '2019-06-06 15:36:29', '12.45', '12.45', '12.45', '12.45'),
    ('7', '1', '2019-06-07 15:36:29', '12.45', '12.45', '12.45', '12.45'),
    ('8', '1', '2019-06-08 15:36:29', '12.45', '12.45', '12.45', '12.45'),
    ('9', '1', '2019-06-09 15:36:29', '12.45', '12.45', '12.45', '12.45'),
    ('10', '1', '2019-06-10 15:36:29', '12.45', '12.45', '12.45', '12.45'),
    ('11', '1', '2019-06-11 15:36:29', '12.45', '12.45', '12.45', '12.45'),
    ('12', '1', '2019-06-12 15:36:29', '12.45', '12.45', '12.45', '12.45'),
    ('13', '1', '2019-06-13 15:36:29', '12.45', '12.45', '12.45', '12.45'),
    ('14', '1', '2019-06-14 15:36:29', '12.45', '12.45', '12.45', '12.45'),
    ('15', '1', '2019-06-15 15:36:29', '12.45', '12.45', '12.45', '12.45'),
    ('16', '1', '2019-06-16 15:36:29', '12.45', '12.45', '12.45', '12.45'),
    ('17', '1', '2019-06-17 15:36:29', '12.45', '12.45', '12.45', '12.45'),
    
    ('18', '2', '2019-06-02 10:16:19', '29.25', '29.25', '29.25', '29.25'),
    ('19', '2', '2019-06-03 10:16:19', '29.25', '29.25', '29.25', '29.25'),
    ('20', '2', '2019-06-04 10:16:19', '29.25', '29.25', '29.25', '29.25'),
    ('21', '2', '2019-06-05 10:16:19', '29.25', '29.25', '29.25', '29.25'),
    ('22', '2', '2019-06-06 10:16:19', '29.25', '29.25', '29.25', '29.25'),
    ('23', '2', '2019-06-07 10:16:19', '29.25', '29.25', '29.25', '29.25'),
    ('24', '2', '2019-06-08 10:16:19', '29.25', '29.25', '29.25', '29.25'),
    ('25', '2', '2019-06-09 10:16:19', '29.25', '29.25', '29.25', '29.25'),
    ('26', '2', '2019-06-10 10:16:19', '29.25', '29.25', '29.25', '29.25'),
    ('27', '2', '2019-06-11 10:16:19', '29.25', '29.25', '29.25', '29.25'),
    ('28', '2', '2019-06-12 10:16:19', '29.25', '29.25', '29.25', '29.25'),
    ('29', '2', '2019-06-13 10:16:19', '29.25', '29.25', '29.25', '29.25'),
    ('30', '2', '2019-06-14 10:16:19', '29.25', '29.25', '29.25', '29.25'),
    ('31', '2', '2019-06-15 10:16:19', '29.25', '29.25', '29.25', '29.25'),
    ('32', '2', '2019-06-16 10:16:19', '29.25', '29.25', '29.25', '29.25'),
    ('33', '2', '2019-06-17 10:16:19', '29.25', '29.25', '29.25', '29.25');

select p.portfolio_id, p.stock_id, p.dte, 
       Sum(t.share) over (partition by p.portfolio_id, p.stock_id order by p.dte) as shares
from (select t.portfolio_id, s.stock_id, generate_series(t.min_td, current_date, interval '1 day') as dte
      from (select portfolio_id, min(transaction_date)::date as min_td
            from transactions t 
            group by portfolio_id
           ) t cross join
           (select distinct stock_id from transactions) s
     ) p left join
     transactions t
     on t.portfolio_id = p.portfolio_id and t.stock_id = p.stock_id and t.transaction_date::date = p.dte
order by 1, 2, 3;

SELECT*
FROM asset_prices;

UPDATE asset_prices
SET isin = upper(isin);